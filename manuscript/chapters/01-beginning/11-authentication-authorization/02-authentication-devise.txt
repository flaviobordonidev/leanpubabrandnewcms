# Login con Devise - installazione

Implementiamo la parte di autenticazione, ossia la parte di login, con la gemma "devise".
Aggiungiamo la gemma **devise** alla nostra applicazione per implementare la parte di autenticazione.
Devise permette di autenticare l'utente per mezzo di un login con user e password. 
Un utente si logga per avere il SUO ambiente di lavoro personalizzato.


Risorse web:

  * https://github.com/plataformatec/devise
  * https://github.com/plataformatec/devise/wiki/Example-Applications
  * http://railsapps.github.io/tutorial-rails-devise-rspec-cucumber.html
  * http://railsapps.github.io/tutorial-rails-mongoid-devise.html
  * Railscasts pro 209-devise-revised
  * http://railsapps.github.io/tutorial-rails-mongoid-devise.html

  * https://www.mirrorcommunications.com/blog/build-a-blog-with-devise-part-2
    In this tutorial, we will install devise and create the user and post model. We will also set up emails in production with the Heroku Sendgrid addon.

  * https://www.mirrorcommunications.com/blog/build-a-blog-with-devise-part-3
    We are likely going to need at least two to three posts just to customize devise. The first thing I want to do is add the FriendlyId gem, so we can create nice looking user and post urls, such as: https://yourdomain/users/your-name.

  * https://github.com/plataformatec/devise/wiki/How-Tos1




## Apriamo il branch "Login Devise Install"

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git checkout -b ldi
~~~~~~~~




## Installiamo la gemma devise

I> verifichiamo [l'ultima versione della gemma](https://rubygems.org/gems/devise)
I>
I> facciamo riferimento al [tutorial github della gemma](https://github.com/plataformatec/devise)

{title="Gemfile", lang=ruby, line-numbers=on, starting-line-number=40}
~~~~~~~~
# Flexible authentication solution for Rails with Warden 
gem 'devise', '~> 4.4', '>= 4.4.3'
~~~~~~~~

[tutto il codice: Gemfile](#beginning-authentication-authorization-rolification-02a-Gemfile)

Eseguiamo l'installazione della gemma con bundle

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ bundle install
~~~~~~~~




## Lo script

Eseguiamo lo script di installazione di devise su rails (Anche noto con il nome di "generator").
Il "generator" installerà un inizializzatore che descrive tutte le opzioni di configurazione di Devise. E' importante leggere e seguire le varie azioni proposte.

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails g devise:install

Running via Spring preloader in process 7804
      create  config/initializers/devise.rb
      create  config/locales/devise.en.yml
===============================================================================

Some setup you must do manually if you haven't yet:

  1. Ensure you have defined default url options in your environments files. Here
     is an example of default_url_options appropriate for a development environment
     in config/environments/development.rb:

       config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

     In production, :host should be set to the actual host of your application.

  2. Ensure you have defined root_url to *something* in your config/routes.rb.
     For example:

       root to: "home#index"

  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
     For example:

       <p class="notice"><%= notice %></p>
       <p class="alert"><%= alert %></p>

  4. You can copy Devise views (for customization) to your app by running:

       rails g devise:views

===============================================================================
~~~~~~~~

Completiamo i 4 punti riportati sul testo che appare dopo devise:install.




### Punto 1

relativo alla parte di settaggio sia in sviluppo che in produzione.

{title=".../config/environments/development.rb", lang=ruby, line-numbers=on, starting-line-number=38}
~~~~~~~~
  # Devise config
  config.action_mailer.default_url_options = { :host => 'localhost:3000' }
~~~~~~~~

[tutto il codice](#beginning-authentication-authorization-rolification-02b-config-environments-development.rb)

Nel prossimo passaggio dobbiamo mettere l'host di produzione. Nel nostro caso quello di heroku. 
Per trovare il nome host su heroku o ci loggiamo oppure usiamo il comando:

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ heroku domains
~~~~~~~~

Adesso che abbiamo il nome dell'host su heroku lo possiamo usare nel file di configurazione.

{title=".../config/environments/production.rb", lang=ruby, line-numbers=on, starting-line-number=72}
~~~~~~~~
  # Devise config
  config.action_mailer.default_url_options = { :host => 'quiet-shelf-47596.herokuapp.com' }
~~~~~~~~

[tutto il codice](#beginning-authentication-authorization-rolification-02c-config-environments-production.rb)

I> Attenzione!
I>
I> Dobbiamo ricordarci di cambiare questo settaggio quando su Heroku punteremo al dominio definitivo. (https://devcenter.heroku.com/articles/using-the-cli).





### punto 2.

Abbiamo già impostato la root sul root file e per il momento lasciamo **root 'test_pages#page_a'**.

[tutto il codice](#beginning-authentication-authorization-rolification-02d-config-routes.rb)





### punto 3.

mettiamo su layouts/application la visualizzazione dei messaggi di avviso

{title=".../app/views/layouts/application.html.erb", lang=HTML+Mako, line-numbers=on, starting-line-number=4}
~~~~~~~~
    <p class="notice"><%= notice %></p>
    <p class="alert"><%= alert %></p>
~~~~~~~~

miglioriamoli un poco, quando installeremo bootstrap saranno ancora meglio.

{title=".../app/views/layouts/application.html.erb", lang=HTML+Mako, line-numbers=on, starting-line-number=4}
~~~~~~~~
    <p class="alert alert-info"><%= notice %></p>
    <p class="alert alert-warning"><%= alert %></p>
~~~~~~~~

visualizziamoli solo quando servono

{title=".../app/views/layouts/application.html.erb", lang=HTML+Mako, line-numbers=on, starting-line-number=4}
~~~~~~~~
    <% if notice %><p class="alert alert-info"><%= notice %></p><% end %>
    <% if alert %><p class="alert alert-warning"><%= alert %></p><% end %>
~~~~~~~~

Successivamente implementeremo un partial più completo **<%= render 'layouts/flash_messages' %>** ma per il momento va bene così.




### punto 4.

Copiamo le views di devise sulla app per permettere la personalizzazione.
Questa operazione la posticipiamo al momento della creazione della tabella **users**.




## Attiviamo la tabella users (ex authors) con devise

Implementiamo il MODEL di devise "User" che crea anche la tabella users usando il **rails** **generate** **devise** ***Model***.

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails g devise User
( ex $ rails g devise Author)
~~~~~~~~

Aggiungiamo una colonna di tipo string al migrate

{title=".../db/migrate/xxx_devise_create_users.rb", lang=ruby, line-numbers=on, starting-line-number=7}
~~~~~~~~
      t.string :name
~~~~~~~~

[tutto il codice](#beginning-authentication-authorization-rolification-02f-db-migrate-xxx_devise_create_users.rb)

Prima di effettuare il migrate verifichiamo il MODEL per eventuali ulteriori opzioni di configurazione che si potrebbe desiderare di aggiungere, ad esempio "confirmable" o "lockable". Se si aggiunge un'opzione, assicurarsi di ispezionare il file di migrate (creato dal generator) e decommentare la sezione appropriata. Ad esempio, se si aggiunge l'opzione "confirmable" nel modello, è necessario togliere il commento alla sezione Confirmable nel migrate.

commentiamo :registerable nel model perché non vogliamo che sia possibile per gli utenti registrarsi come utente

{title=".../app/models/user.rb", lang=ruby, line-numbers=on, starting-line-number=4}
~~~~~~~~
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :registerable, :timeoutable and :omniauthable
  devise :database_authenticatable,
         :recoverable, :rememberable, :trackable, :validatable
end
~~~~~~~~

[tutto il codice](#beginning-authentication-authorization-rolification-02g-models-user.rb)

Effettuiamo il migration.

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ sudo service postgresql start
$ rails db:migrate
~~~~~~~~




## lavoriamo sulle routes.

Sistemiamo gli instradamenti per la parte di autenticazione gestita tramite Devise.

{title=".../config/routes.rb", lang=ruby, line-numbers=on, starting-line-number=6}
~~~~~~~~
  devise_for :users
  resources :users
~~~~~~~~

[tutto il codice](#beginning-authentication-authorization-rolification-02h-config-routes.rb)

I> Attenzione!
I>
I> La route **devise_for :users** deve essere messa prima di **resources :users**






### Aggiungiamo un utente/autore da console

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails c
> User.create(name: 'Flavio Bordoni', email: 'flavio@test.abc', password: 'password', password_confirmation: 'password')
~~~~~~~~

Oppure

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails c
> u = User.new({name: 'Flavio Bordoni', email: 'flavio@example.abc', password: 'password', password_confirmation: 'password'})
> u.save
~~~~~~~~

Da notare che, a differenza dei normali inserimenti nel database, questa volta abbiamo anche delle parentesi graffe **{}** da inserire.

Se avessimo attivato l'opzione **:confirmable** avremmo dovuto **skippare** la **confirmation**

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails c
> u = User.new({email: 'flavio@example.com', password: 'password', password_confirmation: 'password'})
> u.skip_confirmation!
> u.save
~~~~~~~~




### Verifichiamo che funziona sul browser

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ sudo service postgresql start
$ rails s -b $IP -p $PORT
~~~~~~~~

Per verificarlo dobbiamo andare alla pagina **users/sign_in**

https://rebisworldbr1-flaviobordonidev.c9users.io/users/sign_in

Con le credenziali giuste ci loggiamo e veniamo portati nella pagina di root.
Abbiamo impostato nei paragrafi precedenti:
user: flavio@test.abc
password: password




## salviamo su git

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git add -A
$ git commit -m "Install Devise and start implementation"
~~~~~~~~




## Pubblichiamo su Heroku

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git push heroku ldi:master
~~~~~~~~




### ERRORE su Heroku - Manca la secret_key

il **git push heroku ...** si ferma con il seguente errore nella log

remote:        rake aborted!
remote:        Devise.secret_key was not set. Please add the following to your Devise initializer:
remote:        
remote:          config.secret_key = '496bf68dc3...5e3'
remote:        
remote:        Please ensure you restarted your application after installing Devise or setting the key.

Dobbiamo attivare questo secrets. Non editiamo il file config/credentials.yml.enc perché usiamo la secret_key_base che è già impostata.

In Rails 5.2, you have the new credentials file and you must set your credentials secret_key_base to the Devise secret key.

{title=".../config/initializers/devise.rb", lang=ruby, line-numbers=on, starting-line-number=11}
~~~~~~~~
  config.secret_key = Rails.application.credentials.secret_key_base
~~~~~~~~

You'll need to put your RAILS_MASTER_KEY env variable in as well so your app can decrypt the credentials file.

Per far si che heroku riesca a decrittare il file config/credentials.yml.enc dobbiamo passargli la master key.
Quindi apriamo heroku andiamo nella nostra app "quiet-shelf-47596.herokuapp.com"
-> nel tab "settings"
-> nella sezione "Config Vars" facciamo click su "Reveal Config Vars"
-> aggiungiamo RAILS_MASTER_KEY   f458b1a...c4

[vedi immagine 02img-heroku_config_vars.png]

adesso siamo pronti per poter andare in produzione.




## salviamo su git

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git add -A
$ git commit -m "Implement Devise on heroku"
~~~~~~~~




## Riproviamo a Pubblicare su Heroku

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git push heroku ldi:master
$ heroku run rails db:migrate
~~~~~~~~

Installando devise siamo intervenuti sul database locale e quindi dobbiamo aggiornare anche quello remoto su Heroku




## Popoliamo da terminale il database su Heroku

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ heroku run rails c
> User.create(name: 'FB', email: 'flavio@test.abc', password: 'password', password_confirmation: 'password')
> exit
~~~~~~~~

facciamo login su heroku

http://quiet-shelf-47596.herokuapp.com/users/sign_in

email: flavio@test.abc
password: password

 Signed in successfully.




## Chiudiamo il branch

se abbiamo finito le modifiche e va tutto bene:

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git checkout master
$ git merge ldi
$ git branch -d ldi
~~~~~~~~




## Facciamo un backup su Github

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git push origin master
~~~~~~~~










## Paragrafo didattico. Possiamo saltarlo

Se avessimo voluto cambiare il file credentials.yml.enc per impostare la secret di devise allora

Come abbiamo visto nel precedente capitolo sui "secrets" è bene non passare la chiave in chiaro nel file devise.rb ma invece usiamo config/credentials.yml.enc

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ EDITOR=vim rails credentials:edit
~~~~~~~~

si apre vim sempre nel terminale. inseriamo la secret per devise ("i", "CTRL+c", "CTRL+v", "ESC")

~~~~~~~~
# aws:
#   access_key_id: 123
#   secret_access_key: 345

devise:
  secret_key: 496bf68dc3...5e3

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 845ade...0847
~
~~~~~~~~

salviamo ed usciamo da vim (":w", ":q") e riceviamo il messaggio che il file è stato aggiornato.
Attenzione il file è tipo yml quindi si deve indentare. Non usare il "TAB" ma gli spazi della barra spaziatrice. Diamo 2 spazi per restare in standard Rails.

~~~~~~~~
$ EDITOR=vim rails credentials:edit
# New credentials encrypted and saved.
~~~~~~~~

verifichiamo che funziona

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails c
> Rails.application.credentials.devise[:secret_key]     # => "845ade..."
~~~~~~~~

Adesso possiamo passare il secret nel file di inizializzazione di devise

{title=".../config/initializers/devise.rb", lang=ruby, line-numbers=on, starting-line-number=11}
~~~~~~~~
  config.secret_key = Rails.application.credentials.devise[:secret_key]
~~~~~~~~

Solo che ad oggi 19/06/2018 questa non funziona. Si deve fare come spiegato nel paragrafo precedente. ^_^
