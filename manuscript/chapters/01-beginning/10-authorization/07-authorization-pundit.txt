## Autorizzazione

Impostiamo che autorizzazioni ha l'utente, una volta autenticato attraverso il login. 
Noi usiamo Pundit

Attiviamo pundit per autorizzare le modifiche degli utenti solo se la persona è loggata (autenticata) ed ha il ruolo di amministratore (autorizzata).

Ma prima di approfondire Pundit identifichiamo il nostro problema che richiede autenticazione:

Nel sistema di gestione delle aziende abbiamo 2 ruoli, quello del manager e quello del dipendente. 
Il Manager può visualizzare tutte le schermate del sistema. 
Il dipendente non può creare, modificare o cancellare alcuna azienda.


Risorse web

* https://rubygems.org/gems/pundit
* https://github.com/varvet/pundit
* http://railsapps.github.io/rails-authorization.html 
* https://medium.freecodecamp.org/rails-authorization-with-pundit-a3d1afcb8fd2

* https://code.tutsplus.com/tutorials/authorization-with-pundit--cms-28202
* https://medium.com/@stacietaylorcima/implement-user-authorization-with-pundit-rails-80d921cdbf28

* [Episode #047 - Authorization with Pundit](https://www.youtube.com/watch?v=PWizyTjCAdg)




## Apriamo il branch "Pundit Install"

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git checkout -b pi
~~~~~~~~




## Installiamo la gemma

I> verifichiamo [l'ultima versione della gemma](https://rubygems.org/gems/pundit)
I>
I> facciamo riferimento al [tutorial github della gemma](https://github.com/varvet/pundit)

{title="Gemfile", lang=ruby, line-numbers=on, starting-line-number=53}
~~~~~~~~
# Object oriented authorization for Rails applications
gem 'pundit', '~> 2.0'
~~~~~~~~

[tutto il codice: Gemfile](#beginning-authentication-authorization-rolification-08a-Gemfile)

Eseguiamo l'installazione della gemma con bundle

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ bundle install
~~~~~~~~






## Aggiungiamo Pundit ad application_controller

Includiamo Pundit nel nostro application controller.

{title=".../app/controllers/application_controller.rb", lang=ruby, line-numbers=on, starting-line-number=1}
~~~~~~~~
class ApplicationController < ActionController::Base
  include Pundit
  protect_from_forgery with: :exception
~~~~~~~~

Questo ci permette di usare Pundit in tutta la nostra applicazione.

ATTENZIONE
  la parte **  protect_from_forgery with: :exception ** non la ho inserita perché non è di Pundit




## aggiorniamo git 

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git add -A
$ git commit -m "add gem pundit"
~~~~~~~~




## Lo script

Questo passaggio è opzionale ma è interessante farlo per avere una policy generica che erediteremo nelle classi delle policies specifiche per ogni Model da autorizzare. Quindi eseguiamo lo script di implementazione di pundit su rails (Anche noto con il nome di "generator"). Il "generator" will set up an application policy with some useful defaults.

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ rails g pundit:install

Running via Spring preloader in process 1762
      create  app/policies/application_policy.rb
~~~~~~~~

After generating your application policy, restart the Rails server so that Rails can pick up any classes in the new app/policies/ directory.

[tutto il codice: Gemfile](#beginning-authentication-authorization-rolification-08b-08b-app-policies-application_policy)


E con questo abbiamo predisposto l'ambiente di pundit. Nel prossimo capitolo inizieremo ad usarlo per le autorizzazioni.




## archiviamo su git

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git add -A
$ git commit -m "install pundit"
~~~~~~~~




## Publichiamo su heroku

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git push heroku pi:master
~~~~~~~~




## Chiudiamo il branch

se abbiamo finito le modifiche e va tutto bene:

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git checkout master
$ git merge pi
$ git branch -d pi
~~~~~~~~




## Facciamo un backup su Github

Dal nostro branch master di Git facciamo un backup di tutta l'applicazione sulla repository remota Github.

{title="terminal", lang=bash, line-numbers=off}
~~~~~~~~
$ git push origin master
~~~~~~~~
